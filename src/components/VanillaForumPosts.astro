---
import { getDiscussions, getPopularDiscussions } from '../utils/vanillaApi';
import type { FormattedDiscussion } from '../utils/vanillaApi';

// State management
let recentDiscussions: FormattedDiscussion[] = [];
let popularDiscussions: FormattedDiscussion[] = [];
let isLoading: boolean = true;
let error: string | null = null;

// Fetch data from Vanilla API
try {
  // Fetch both recent and popular discussions concurrently
  const [recent, popular] = await Promise.all([
    getDiscussions(),
    getPopularDiscussions()
  ]);
  recentDiscussions = recent;
  popularDiscussions = popular;
  isLoading = false;
} catch (err) {
  error = 'Failed to fetch forum posts';
  isLoading = false;
}
---

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <!-- Recent Discussions -->
  <div class="bg-neutral-100 dark:bg-[#0A1628] rounded-xl shadow-md overflow-hidden mb-10 p-8">
    <h2 class="text-2xl font-bold text-neutral-800 dark:text-neutral-200 sm:text-3xl mb-5"><span class="text-blue-500 dark:text-blue-400">Latest</span> Posts</h2>

    {isLoading && (
      <div class="flex justify-center items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-gray-400"></div>
      </div>
    )}

    {error && (
      <div class="text-red-500 font-bold p-4 rounded bg-red-100">
        <p>Error: {error}</p>
      </div>
    )}

    {!isLoading && !error && recentDiscussions.slice(0, 5).map((discussion) => (
      <div class="mb-8 pb-8 border-b border-gray-700/20 last:border-b-0 last:mb-0 last:pb-0">
        <div class="flex gap-4">
          <div class="flex-shrink-0">
            <a href={`https://forum.commercequest.space/profile/${discussion.author.userID}`} class="block hover:opacity-90">
              <img src={discussion.author.photoUrl} alt={discussion.author.name} class="w-12 h-12 rounded-full" />
            </a>
          </div>
          <div class="flex-grow min-w-0">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white leading-tight">
              <a href={discussion.url} class="hover:underline">{discussion.name}</a>
            </h3>
            
            <p class="text-gray-600 dark:text-gray-300 text-base mt-2 leading-relaxed">
              <a href={discussion.url} class="hover:underline">{discussion.description}</a>
            </p>

            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-3 text-sm text-gray-500 dark:text-gray-400">
              <span>Started by <a href={`https://forum.commercequest.space/profile/${discussion.author.userID}`} class="hover:underline">{discussion.author.name}</a></span>
              <span class="text-gray-300 dark:text-gray-600">•</span>
              <a href={discussion.url} class="hover:underline">{discussion.commentCount} comments</a>
              <span class="text-gray-300 dark:text-gray-600">•</span>
              <a href={discussion.url} class="hover:underline">{discussion.viewCount} views</a>
            </div>
          </div>
        </div>
      </div>
    ))}
  </div>

  <!-- Popular Discussions -->
  <div class="bg-neutral-100 dark:bg-[#0A1628] rounded-xl shadow-md overflow-hidden mb-10 p-8">
    <h2 class="text-2xl font-bold text-neutral-800 dark:text-neutral-200 sm:text-3xl mb-5"><span class="text-pink-500 dark:text-pink-400">Recently Popular</span> Posts</h2>

    {isLoading && (
      <div class="flex justify-center items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-gray-400"></div>
      </div>
    )}

    {error && (
      <div class="text-red-500 font-bold p-4 rounded bg-red-100">
        <p>Error: {error}</p>
      </div>
    )}

    {!isLoading && !error && popularDiscussions.map((discussion) => (
      <div class="mb-8 pb-8 border-b border-gray-700/20 last:border-b-0 last:mb-0 last:pb-0">
        <div class="flex gap-4">
          <div class="flex-shrink-0">
            <a href={`https://forum.commercequest.space/profile/${discussion.author.userID}`} class="block hover:opacity-90">
              <img src={discussion.author.photoUrl} alt={discussion.author.name} class="w-12 h-12 rounded-full" />
            </a>
          </div>
          <div class="flex-grow min-w-0">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white leading-tight">
              <a href={discussion.url} class="hover:underline">{discussion.name}</a>
            </h3>
            
            <p class="text-gray-600 dark:text-gray-300 text-base mt-2 leading-relaxed">
              <a href={discussion.url} class="hover:underline">{discussion.description}</a>
            </p>

            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-3 text-sm text-gray-500 dark:text-gray-400">
              <span>Started by <a href={`https://forum.commercequest.space/profile/${discussion.author.userID}`} class="hover:underline">{discussion.author.name}</a></span>
              <span class="text-gray-300 dark:text-gray-600">•</span>
              <a href={discussion.url} class="hover:underline">{discussion.commentCount} comments</a>
              <span class="text-gray-300 dark:text-gray-600">•</span>
              <a href={discussion.url} class="hover:underline">{discussion.viewCount} views</a>
            </div>
          </div>
        </div>
      </div>
    ))}
  </div>
</div>
